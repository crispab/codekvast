buildscript {
    repositories { maven { url 'https://maven.eveoh.nl/content/repositories/releases' } }
    dependencies {
        classpath 'nl.eveoh:gradle-aspectj:1.4'
    }
}
plugins {
    id "com.github.johnrengelman.shadow" version "1.2.0"
}
apply from: "$rootDir/gradle/java-6.gradle"
apply plugin: 'aspectj'
apply from: "$rootDir/gradle/sources-javadoc.gradle"

description = "The javaagent part of Codekvast agent"
archivesBaseName = "codekvast-agent-collector"
version = project.parent.parent.version

configurations {
    aspectjweaver
}

dependencies {
    // cannot use lombok here, since this is an AspectJ project
    compile project(":product:agent:util"), { transitive = false }
    compile "org.aspectj:aspectjweaver:$aspectjVersion"

    aspectjweaver "org.aspectj:aspectjweaver:$aspectjVersion"

    // Absolutely NO other compile or runtime dependencies are allowed here!
    // All (transitive) compile and runtime dependencies will end up in the instrumented app's system
    // class path, which is unacceptable.

    testCompile junit
    testCompile mockito
}

shadowJar {
    baseName = "codekvast-collector"
    classifier = ''
    manifest { attributes("Premain-Class": "se.crisp.codekvast.agent.collector.CodekvastCollector") }
    dependencies {
        exclude(dependency('org.aspectj:aspectjweaver'))
    }
}

task javaagents(type: Sync) {
    from configurations.aspectjweaver
    from tasks.shadowJar
    into "$buildDir/javaagents"
}
