#!/usr/bin/env bash
#----------------------------------------------------------------------------
# Make a backup of all MariaDB databases in this host by means of mariabackup
#----------------------------------------------------------------------------

declare weekday=${1:-$(date --utc +%A | tr [A-Z] [a-z])}
declare targetDir={{ mysql_backup_dir }}/latest
declare tarball={{ mysql_backup_dir }}/mariabackup-$weekday.tar.gz
declare bucket={{ s3_database_backup_bucket }}

set -e

rm -fr $targetDir
mkdir -p $targetDir

mariabackup --backup --skip-backup-encrypted --user=root --password={{ mysql_root_password }} --target-dir=$targetDir

cd $targetDir
tar czf $tarball *

s3cmd --config=/root/s3cfg --progress --force put $tarball s3://$bucket
s3cmd --config=/root/s3cfg ls s3://$bucket
