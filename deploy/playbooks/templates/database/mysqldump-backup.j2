#!/usr/bin/env bash
#----------------------------------------------------------------------------
# Make a backup of the MariaDB database 'codekvast' in this host by means of mysqldump
#----------------------------------------------------------------------------

declare weekday=${1:-$(date --utc +%A | tr [A-Z] [a-z])}
declare dumpfile={{ mysql_backup_dir }}/mysqldump-${weekday}.sql.gz
declare bucket={{ s3_database_backup_bucket }}

set -e

mysqldump --user=root --password={{ mysql_root_password }} codekvast | gzip > ${dumpfile}.new
mv --force ${dumpfile}.new ${dumpfile}

s3cmd --config=/root/s3cfg --progress --force put ${dumpfile} s3://${bucket}
s3cmd --config=/root/s3cfg ls s3://${bucket}
